<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GN MISSIONS – Création du personnage</title>
  <style>
    :root{
      --ink:#e7e3d9; --bg:#0c1423; --panel:#111a2a; --frame:#6a6a63; --accent:#c92f2f; --grid:#51514c; --slot:#0b1530;
      --font: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --ocr:'Share Tech Mono',monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(#0a1120,#070b14);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    .page{display:grid;grid-template-columns:360px 1fr;gap:12px;min-height:100vh;padding:12px}
    .card{background:#0b1426;border:1px solid #1e2a3f;border-radius:14px;box-shadow:0 0 0 1px #0b1220 inset, 0 8px 24px rgba(0,0,0,.35)}
    .card .head{padding:14px 16px;border-bottom:1px solid #1e2a3f}
    .card h2{margin:0;font-size:18px;letter-spacing:.5px;text-transform:uppercase;color:#cfd8ff}
    .card .body{padding:14px 16px}

    label{font-size:13px;opacity:.9;display:block;margin:8px 0 6px}
    select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3a58;background:#0b1222;color:var(--ink);font:14px/1.2 var(--font)}

    /* Aperçu RE1 */
    .previewWrap{position:relative;width:100%;min-height:900px;background:#0b0f1f;border:1px solid #2a3a58;border-radius:14px;overflow:visible;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05)}
    .re1{position:relative;padding:12px;background:#061024;color:#ddd;font-family:var(--font);display:grid;grid-template-columns:170px 1fr;grid-template-rows:auto auto auto auto auto;gap:12px;align-content:stretch}
    .portrait{width:150px;height:150px;border:2px solid var(--frame);background:#0c1426 center/cover no-repeat;display:grid;place-items:center;grid-column:1;grid-row:1 / span 2;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .portrait img{width:100%;height:100%;object-fit:cover;display:block;border:0}
    .topTabs{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;align-items:center}

    .tab{height:48px;border:2px solid var(--accent);background:linear-gradient(#3b0f10,#2a0a0a);display:flex;align-items:center;justify-content:center;padding:6px 8px;font:22px var(--ocr);color:#ffe7e7;letter-spacing:.5px;text-transform:uppercase;overflow:hidden;text-overflow:ellipsis;transition:font-size 0.2s ease;white-space:normal;line-height:1.1}
    #jobSlot, #traitSlot{white-space:normal;text-overflow:clip;line-height:1.1;padding:4px 6px;word-break:break-word}

    .summary{grid-column:2;grid-row:2;border:2px solid var(--frame);background:#0a0f18;padding:28px 8px 8px;position:relative;min-height:86px}
    .cond{grid-column:1 / span 2;grid-row:3;min-height:120px;border:2px solid var(--frame);background:#0a1914;position:relative;padding:28px 8px 8px}
    .itemsPanel{grid-column:1 / span 2;grid-row:4;border:2px solid var(--frame);background:#0a1031;padding:28px 8px 8px;position:relative}
    .grid{display:grid;grid-template-columns:repeat(6,96px);grid-template-rows:repeat(2,96px);gap:12px;justify-content:center;align-content:start}
    .slot{border:2px solid var(--grid);background:#0b1530;width:96px;height:96px;display:grid;place-items:center}
    .bgBottom{grid-column:1 / span 2;grid-row:5;min-height:220px;border:2px solid var(--frame);background:#08112a;padding:28px 10px 10px;line-height:1.4;position:relative}
    .panelTitle{position:absolute;top:6px;left:8px;background:linear-gradient(#8a1b1b,#5e1111);border:1px solid #a22a2a;border-radius:4px;padding:2px 8px;color:#ffebeb;font:700 12px var(--ocr);letter-spacing:.6px;text-transform:uppercase}
    #summaryText{white-space:pre-wrap}
    #bgContent{white-space:pre-wrap}

    .stack{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #2a3a58;border-radius:999px;background:#0c1730;font:13px var(--font)}
    .badge{display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;padding:0 6px;border-radius:999px;border:1px solid #2a3a58;background:#172447;font:12px var(--font)}
    .cat{font:12px var(--font);opacity:.9;padding:2px 6px;border:1px dashed #2a3a58;border-radius:999px}
    .limit{font:12px var(--font);opacity:.9}
  </style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div class="page">
    <!-- Panneau gauche -->
    <section class="card" id="controls">
      <div class="head"><h2>CRÉATION DE PERSONNAGE</h2></div>
      <div class="body">
        <label for="character">Choix du personnage</label>
        <select id="character"></select>

        <hr style="border:none;border-top:1px solid #1e2a3f;margin:14px 0" />
        <label>Compétences (<span id="skillCount">0</span>/ <span id="skillLimit">8</span>)</label>
        <label for="catFilter" style="margin-top:6px">Filtrer par catégorie</label>
        <select id="catFilter">
          <option value="__all__">Toutes</option>
          <option>Combat</option>
          <option>Médical</option>
          <option>Tech</option>
          <option>Social</option>
          <option>Survie</option>
          <option>Science</option>
          <option>Média</option>
          <option>Négociation</option>
          <option>Spécial</option>
        </select>
        <div id="skills" class="stack"></div>
        <div id="skillHint" class="limit">Maximum 8 compétences. Les compétences uniques du personnage sont ajoutées automatiquement.</div>
      </div>
    </section>

    <!-- Aperçu RE1 -->
    <section class="card">
      <div class="head"><h2>Expérience et Expédition</h2></div>
      <div class="body">
        <div class="previewWrap" id="capture">
          <div class="re1">
            <div class="portrait" id="portrait"><span>Portrait du personnage</span></div>
            <div class="topTabs">
              <div class="tab" id="nameSlot">NOM et PRENOM du personnage</div>
              <div class="tab" id="jobSlot">METIER DU PERSONNAGE</div>
              <div class="tab" id="traitSlot">TRAIT DE CARACTERE DU PJ</div>
            </div>
            <div class="summary"><div class="panelTitle">Pitch du personnage</div><div id="summaryText"></div></div>
            <div class="cond"><div class="panelTitle">Compétences</div><div id="desc">Compétences sélectionnées : aucune.</div></div>
            <aside class="itemsPanel"><div class="panelTitle">Inventaire</div><div class="grid" id="grid"></div></aside>
            <div class="bgBottom"><div class="panelTitle">BG</div><div id="bgContent">Proposition de Background du personnage écrit par le Joueur</div></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
  (function(){
    // --- Portraits (Cloudinary) ---
    var PORTRAITS = {
      'Alfred-Aubertin':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309428/alfred-aubertin.png',
      'Bernard-Boucher':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309428/bernard-boucher.png',
      'Christian-Cottin':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309429/christian-cottin.png',
      'Daniel-Delmas':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309429/daniel-delmas.png',
      'Elsa-Escudier':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309429/elsa-escudier.png',
      'Francis-Ferrand':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309428/francis-ferrand.png',
      'Gina-Gauthier':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309429/gina-gauthier.png',
      'Héléna-Harel':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309429/helena-harel.png',
      'Isaac-Isman':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309429/isaac-isman.png',
      'Juan-Joubert':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309429/juan-joubert.png',
      'Kara-Krief':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309430/kara-krief.png',
      'Léonard-Lemoine':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309430/leonard-lemoine.png',
      'Maurice-Marchand':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309430/maurice-marchand.png',
      'Nathan-Nouvel':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309430/nathan-nouvel.png',
      'Olivier-Orsini':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309430/olivier-orsini.png',
      'Peter-Pommier':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309430/peter-pommier.png',
      'Quentin-Quere':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309437/quentin-quere.png',
      'Ruben-Roussel':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309437/ruben-roussel.png',
      'Sarah-Séguin':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309437/sarah-seguin.png',
      'Thierry-Teboul':'https://res.cloudinary.com/druqmayyr/image/upload/v1760309437/thierry-teboul.png'
    };

    // --- Métier & Traits (source de vérité) ---
    var CHAR_META = {
      'Alfred-Aubertin': { profession: 'Major', traits: 'Discipline, ordre' },
      'Bernard-Boucher': { profession: 'Sergent', traits: 'Sociable, protecteur' },
      'Christian-Cottin': { profession: 'Caporal', traits: 'Calme, fidèle' },
      'Daniel-Delmas': { profession: 'Caporal', traits: 'Courageux, fougueux' },
      'Elsa-Escudier': { profession: 'Sergent-chef', traits: 'Empathique, déterminée' },
      'Francis-Ferrand': { profession: 'Soldat', traits: 'Hiérarchique, rigide' },
      'Gina-Gauthier': { profession: 'Biologiste', traits: 'Exigeante, perfectionniste' },
      'Héléna-Harel': { profession: 'Infectiologue', traits: 'Ambitieuse, séduisante' },
      'Isaac-Isman': { profession: 'Généticien', traits: 'Impulsif, curieux' },
      'Juan-Joubert': { profession: 'Physicien', traits: 'Rigoureux, sérieux' },
      'Kara-Krief': { profession: 'Psychologue', traits: 'Curieuse, posée' },
      'Léonard-Lemoine': { profession: 'Journaliste TV', traits: 'Charismatique, cynique' },
      'Maurice-Marchand': { profession: 'Photographe de guerre', traits: 'Discret, obstiné' },
      'Nathan-Nouvel': { profession: 'Caméraman', traits: 'Observateur, loyal' },
      'Olivier-Orsini': { profession: 'Négociateur', traits: 'Expérimenté, protecteur' },
      'Peter-Pommier': { profession: 'Preneur de son', traits: 'Discret, méticuleux' },
      'Quentin-Quere': { profession: 'Négociateur', traits: 'Charismatique, arrogant' },
      'Ruben-Roussel': { profession: 'Berger', traits: 'Rustique, idéaliste' },
      'Sarah-Séguin': { profession: 'Infirmière volontaire', traits: 'Pragmatique, protectrice' },
      'Thierry-Teboul': { profession: 'Bûcheron', traits: 'Solitaire, rustique' }
    };

    // --- Réfs DOM ---
    var select = document.getElementById('character');
    var portraitBox = document.getElementById('portrait');
    var nameSlot = document.getElementById('nameSlot');
    var jobSlot = document.getElementById('jobSlot');
    var traitSlot = document.getElementById('traitSlot');
    var skillsDiv = document.getElementById('skills');
    var skillCountEl = document.getElementById('skillCount');
    var skillLimitEl = document.getElementById('skillLimit');
    var skillHint = document.getElementById('skillHint');
    var grid = document.getElementById('grid');
    var desc = document.getElementById('desc');
    var catFilter = document.getElementById('catFilter');

    // --- Compétences ---
    var MAX_SKILLS = 8;
    // Dictionnaire complet des compétences avec catégorie + niveau (1-3). Les "uniques" listent leurs porteurs.
    var SKILL_BOOK = {
      // Communes
      'Tir':           {cat:'Combat', level:1, holders:[]},
      'Discrétion':    {cat:'Survie', level:2, holders:[]},
      'Mécanique':     {cat:'Tech',   level:1, holders:[]},
      'Premiers soins':{cat:'Médical',level:2, holders:[]},
      'Survie':        {cat:'Survie', level:2, holders:[]},
      'Athlétisme':    {cat:'Survie', level:1, holders:[]},
      'Négociation':   {cat:'Social', level:2, holders:[]},
      'Observation':   {cat:'Survie', level:1, holders:[]},
      'Crochetage':    {cat:'Tech',   level:2, holders:[]},
      'Explosifs':     {cat:'Tech',   level:3, holders:[]},
      'Conduite':      {cat:'Tech',   level:1, holders:[]},
      'Informatique':  {cat:'Tech',   level:2, holders:[]},
      // Uniques (exemples)
      'Commandement':       {cat:'Social', level:3, holders:['Alfred-Aubertin','Bernard-Boucher']},
      'Tactique avancée':   {cat:'Combat', level:3, holders:['Alfred-Aubertin']},
      'Logistique':         {cat:'Spécial',level:2, holders:['Bernard-Boucher']},
      'Bravoure':           {cat:'Combat', level:2, holders:['Daniel-Delmas']},
      'Soins intensifs':    {cat:'Médical',level:3, holders:['Elsa-Escudier']},
      'Microbiologie':      {cat:'Science',level:3, holders:['Gina-Gauthier']},
      'Diagnostic rare':    {cat:'Médical',level:3, holders:['Héléna-Harel']},
      'CRISPR':             {cat:'Science',level:3, holders:['Isaac-Isman']},
      'Calcul scientifique':{cat:'Science',level:3, holders:['Juan-Joubert']},
      'Profilage':          {cat:'Social', level:2, holders:['Kara-Krief']},
      'Interview':          {cat:'Média',  level:2, holders:['Léonard-Lemoine']},
      'Développement photo':{cat:'Média',  level:2, holders:['Maurice-Marchand']},
      'Stabilisation caméra':{cat:'Média', level:2, holders:['Nathan-Nouvel']},
      'Médiation':          {cat:'Négociation',level:2, holders:['Olivier-Orsini']},
      'Prise de son pro':   {cat:'Média',  level:2, holders:['Peter-Pommier']},
      'Rhétorique':         {cat:'Social', level:3, holders:['Quentin-Quere']},
      'Pistage animal':     {cat:'Survie', level:2, holders:['Ruben-Roussel']},
      'Triage':             {cat:'Médical',level:2, holders:['Sarah-Séguin']},
      'Abattage':           {cat:'Survie', level:2, holders:['Thierry-Teboul']}
    };

    function listSkillsForCharacter(key){
      var out = [];
      for(var k in SKILL_BOOK){ if(!SKILL_BOOK.hasOwnProperty(k)) continue; var meta = SKILL_BOOK[k];
        var isCommon = !meta.holders || meta.holders.length===0;
        var isHeld = meta.holders && meta.holders.indexOf(key)>=0;
        if(isCommon || isHeld) out.push(k);
      }
      // tri par catégorie puis par nom
      out.sort(function(a,b){ var ca=SKILL_BOOK[a].cat, cb=SKILL_BOOK[b].cat; return ca===cb ? a.localeCompare(b) : ca.localeCompare(cb); });
      return out;
    }

    function onSkillToggle(){
      var picked=getPickedSkills();
      if(picked.length>MAX_SKILLS){ this.checked=false; return; }
      updateSkillSummary();
    }

    function getPickedSkills(){
      if(!skillsDiv) return [];
      var cbs=skillsDiv.querySelectorAll('input[type="checkbox"]');
      var out=[]; for(var i=0;i<cbs.length;i++){ if(cbs[i].checked) out.push(cbs[i].dataset.label); }
      return out;
    }

    function renderSkillsFor(key){
      if(!skillsDiv) return;
      var selectedCat = catFilter ? catFilter.value : '__all__';
      var skills = listSkillsForCharacter(key);
      skillsDiv.innerHTML='';
      for(var i=0;i<skills.length;i++){
        var label = skills[i]; var meta = SKILL_BOOK[label] || {cat:'Spécial', level:1};
        if(selectedCat && selectedCat!=='__all__' && meta.cat!==selectedCat) continue;
        var wrap=document.createElement('label'); wrap.className='chip';
        var cb=document.createElement('input'); cb.type='checkbox'; cb.dataset.label=label; cb.addEventListener('change', onSkillToggle);
        var nameNode=document.createElement('span'); nameNode.textContent=label;
        var badge=document.createElement('span'); badge.className='badge'; badge.title='Niveau'; badge.textContent=meta.level;
        var cat=document.createElement('span'); cat.className='cat'; cat.textContent=meta.cat;
        wrap.appendChild(cb); wrap.appendChild(nameNode); wrap.appendChild(badge); wrap.appendChild(cat);
        skillsDiv.appendChild(wrap);
      }
      if(skillLimitEl) skillLimitEl.textContent=MAX_SKILLS;
      updateSkillSummary();
    }

    function updateSkillSummary(){
      var picked=getPickedSkills();
      if(skillCountEl) skillCountEl.textContent=picked.length;
      var target=document.getElementById('desc');
      if(target) target.textContent = picked.length? ('Compétences sélectionnées : '+picked.join(', ')) : 'Compétences sélectionnées : aucune.';
    }

    // --- Utils ---
    function norm(s){
      return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,'-').replace(/_/g,'-').replace(/[^a-z0-9-]/g,'');
    }

    // *** Font autosize pour Métier & Traits (agrandit 50%, ne réduit que si dépasse) ***
    function setTabText(el, text){
      if(!el) return;
      el.textContent = text || '';
      var ref = parseFloat(window.getComputedStyle(nameSlot).fontSize) || 22;
      var current = Math.round(ref * 1.5); // +50%
      var min = 15;
      el.style.fontSize = current + 'px';
      var guard = 0, pad = 4;
      while(guard < 40 && current > min && (el.scrollWidth > el.clientWidth - pad || el.scrollHeight > el.clientHeight - pad)){
        current -= 1; guard += 1; el.style.fontSize = current + 'px';
      }
    }

    // --- Helpers portrait ---
    function setPortrait(src){
      if(!portraitBox) return;
      var test = new Image();
      test.onload = function(){
        portraitBox.innerHTML='';
        portraitBox.style.backgroundImage='url("'+src+'")';
        portraitBox.style.backgroundSize='cover';
        portraitBox.style.backgroundPosition='center';
      };
      test.onerror = function(){ portraitBox.style.backgroundImage='none'; portraitBox.innerHTML='<span>Portrait du personnage</span>'; };
      test.src = src;
    }

    // --- Changement de personnage ---
    function onCharacterChange(){
      if(!select) return;
      var opt = select.options[select.selectedIndex];
      var key = opt ? opt.dataset.key : '';
      var display = key ? key.replace(/-/g,' ') : 'NOM et PRENOM du personnage';
      nameSlot.textContent = display;
      var meta = CHAR_META[key] || {profession:'', traits:''};
      setTabText(jobSlot, meta.profession || '—');
      setTabText(traitSlot, meta.traits || '—');
      var url = PORTRAITS[key] || '';
      if(url) setPortrait(url); else { portraitBox.style.backgroundImage='none'; portraitBox.innerHTML='<span>Portrait du personnage</span>'; }
      // MAJ compétences
      renderSkillsFor(key);
    }

    // --- Peupler sélecteur & grille ---
    function populate(){
      // select
      select.innerHTML='';
      Object.keys(PORTRAITS).forEach(function(k){ var o=document.createElement('option'); o.value=norm(k); o.dataset.key=k; o.textContent=k.replace(/-/g,' '); select.appendChild(o);});
      // grille 6x2
      if(grid){ grid.innerHTML=''; for(var i=0;i<12;i++){ var c=document.createElement('div'); c.className='slot'; grid.appendChild(c);} }
      if(select.options.length){ select.selectedIndex=0; onCharacterChange(); }
    }

    // Listeners
    select.addEventListener('change', onCharacterChange);
    if(catFilter){ catFilter.addEventListener('change', function(){ var o=select.options[select.selectedIndex]; var kk=o?o.dataset.key:''; renderSkillsFor(kk); }); }

    // Init
    populate();
    if(select && select.options.length){ var k = select.options[select.selectedIndex].dataset.key; renderSkillsFor(k); }
  })();
  </script>

<script>
(function(){
  function $(s){ return document.querySelector(s); }
  var sendOrgaBtn = $("#sendOrgaBtn");
  var select = $("#character");
  function collect(){
    var o = select && select.options[select.selectedIndex];
    var charKey = o && o.dataset ? o.dataset.key : "";
    var charName = o ? o.textContent : "";
    var skillCount = (document.querySelector('#skillCount')||{}).textContent || "";
    var skillLimit = (document.querySelector('#skillLimit')||{}).textContent || "";
    var bg = (document.querySelector('#bgInput')||{}).value || (document.querySelector('#bgContent')||{}).textContent || "";
    return { charKey, charName, skillCount, skillLimit, bg };
  }
  async function send(){
    if(!sendOrgaBtn) return;
    sendOrgaBtn.disabled = true; sendOrgaBtn.textContent = "Envoi…";
    try{
      var data = collect();
      var payload = {
        to: ["orga.paradoxa@proton.me","rcohensolal@georem.net"],
        subject: "[MISSIONS] Création de personnage – " + (data.charName || "PJ"),
        text: "Bonjour,\n\nVeuillez trouver ci-joint la fiche de personnage créée par le joueur.\n\n— Système MISSIONS",
        character: { key: data.charKey, name: data.charName, bg: data.bg, skillsCount: data.skillCount, skillsLimit: data.skillLimit }
      };
      var capture = document.getElementById('capture') || document.body;
      try {
        var canvas = await html2canvas(capture, {backgroundColor:'#ffffff', scale:2, useCORS:true, allowTaint:false});
        payload.preview_png = canvas.toDataURL('image/png');
      } catch(e){ payload.preview_html = capture.outerHTML; }
      var res = await fetch('/api/send-character', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error("HTTP "+res.status);
      alert("Envoyé aux orgas ✅");
    }catch(e){
      alert("Échec de l'envoi : " + e.message);
    }finally{
      sendOrgaBtn.disabled = false; sendOrgaBtn.textContent = "Envoyer aux orgas";
    }
  }
  if(sendOrgaBtn){ sendOrgaBtn.addEventListener('click', send); }
})();
</script>

</body>
</html>
